name: Build & Deploy Assets

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            DEPLOY_API_BASE: ${{ secrets.DEPLOY_API_BASE }}
            DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: 20

            -   name: Install dependencies
                run: npm ci

            -   name: Build Assets
                run: npx tsx src/build.mts

            -   name: Pack Artifacts
                run: |
                    cd public
                    tar -cf ../dist.tar .

            -   name: Upload Assets
                run: |
                    curl -f --fail-with-body \
                     --connect-timeout 10 \
                     --max-time 300 \
                     --retry 3 \
                     --retry-delay 5 \
                     --retry-connrefused \
                     -X POST "${DEPLOY_API_BASE}/upload" \
                     -H "Authorization: Bearer ${DEPLOY_TOKEN}" \
                     -F "version=${GITHUB_SHA}" \
                     -F "artifact=@dist.tar"

            -   name: Deploy Assets
                run: |
                    resp=$(curl -f -s --fail-with-body \
                      --connect-timeout 5 \
                      --max-time 30 \
                      --retry 3 \
                      --retry-delay 3 \
                      --retry-connrefused \
                      -X POST "${DEPLOY_API_BASE}/deploy" \
                      -H "Authorization: Bearer ${DEPLOY_TOKEN}" \
                      -H "Content-Type: application/json" \
                      -d '{"version":"'"${GITHUB_SHA}"'"}')
                    
                    echo "$resp"
                    echo "$resp" | jq -e '.status == "ok"'

            -   name: Verify Active Version
                run: |
                    curl -s \
                      --connect-timeout 5 \
                      --max-time 10 \
                      "${DEPLOY_API_BASE}/status" \
                      -H "Authorization: Bearer ${DEPLOY_TOKEN}" | jq